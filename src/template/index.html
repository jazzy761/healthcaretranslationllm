<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <h2>ğŸ™ï¸ Speech Translator</h2>

    <button id="recordBtn">ğŸ¤ Start Recording</button>
    <p id="status"></p>

    <div id="result" style="display:none;">
        <h3>Original:</h3>
        <p id="originalText"></p>
        <audio id="originalAudio" controls></audio>

        <h3>Translated:</h3>
        <p id="translatedText"></p>
        <audio id="translatedAudio" controls></audio>
    </div>

    <script>
        const recordBtn = document.getElementById("recordBtn");
        const statusEl = document.getElementById("status");
        const originalTextEl = document.getElementById("originalText");
        const translatedTextEl = document.getElementById("translatedText");
        const originalAudioEl = document.getElementById("originalAudio");
        const translatedAudioEl = document.getElementById("translatedAudio");
        const resultDiv = document.getElementById("result");

        let recognition;
        let isRecording = false;

        if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
            alert("Your browser does not support the Web Speech API. Please use Chrome or Edge.");
        } else {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.lang = "en-US";
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            recognition.onstart = () => {
                statusEl.innerText = "Recording...";
                recordBtn.innerText = "â¹ Stop Recording";
                isRecording = true;
            };

            recognition.onresult = async (event) => {
                const spokenText = event.results[0][0].transcript;
                statusEl.innerText = "Processing...";
                
                // Send text to backend
                const formData = new FormData();
                formData.append("text", spokenText);

                try {
                    const res = await fetch("/translate", { method: "POST", body: formData });
                    const data = await res.json();

                    if (data.error) {
                        statusEl.innerText = "Error: " + data.error;
                        return;
                    }

                    originalTextEl.innerText = data.original_text;
                    translatedTextEl.innerText = data.translated_text;
                    originalAudioEl.src = data.original_audio;
                    translatedAudioEl.src = data.translated_audio;
                    resultDiv.style.display = "block";
                    statusEl.innerText = "Done!";
                } catch (e) {
                    statusEl.innerText = "Error: " + e.message;
                }
            };

            recognition.onerror = (event) => {
                statusEl.innerText = "Error: " + event.error;
                isRecording = false;
                recordBtn.innerText = "ğŸ¤ Start Recording";
            };

            recognition.onend = () => {
                if (isRecording) {
                    // Automatically stop recording after speech ends
                    recognition.stop();
                    isRecording = false;
                    recordBtn.innerText = "ğŸ¤ Start Recording";
                    
                }
            };
        }

        recordBtn.addEventListener("click", () => {
            if (isRecording) {
                recognition.stop();
            } else {
                recognition.start();
            }
        });
    </script>
</body>
</html>
